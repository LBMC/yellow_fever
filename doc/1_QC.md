---
title: "Quality Control Analysis"
author: Laurent Modolo [laurent.modolo@ens-lyon.fr](mailto:laurent.modolo@ens-lyon.fr)
date: 2017/11/22
output:
  pdf_document:
    toc: true
    toc_depth: 1
    number_section: true
    highlight: tango
    latex_engine: xelatex
---

Every step of this analysis is wrapped inside the package `scRNAtools`.
To run this analysis in R, you can run the script `src/1_QC.R` after installing
this package.

# filter outlier

Except if stated otherwise, we analyse the *in vivo* male donor data. For cells
that are in day 15, 136 or 593, sequenced in paired-end.
We also exclude batch 6 to 8 that are of poor quality, and cells P1299\_1797
and P1299_1896 that are huge outlier on a PCA.

\begin{center}
  \includegraphics[width=\textwidth]{../results/QC/pca/pca_abundance_outliers.pdf}
\end{center}

We load the data with the following command to create an `scdata object` called
`scd`.

```R
scd <- scRNAtools::load_data_salmon(
  infos = "data/Summary_SSEQ.csv",
  counts = "data/salmon_output/",
  feature = "counts",
  tximport_obj = "results/tmp/tmp_tximport",
  infos_sep = ","
)
scd$setfeature(
  "sequencing",
  ifelse(
    grepl("P1373", scd$getfeature("id")),
    "single",
    "paired"
  )
)
scd$setfeature(
  "to_QC",
  scd$getfeature("sex") %in% "M" &
  scd$getfeature("day") %in% c("D15", "D136", "D593") &
  scd$getfeature("sequencing") %in% "paired" &
  !(scd$getfeature("batch") %in% c(6:8)) &
  !(scd$getcells %in% c("P1299_1797", "P1299_1896"))
save(scd, file = "results/counts.Rdata")
```

The `to_QC` feature design cells for which we want to identify cells looking
like blanks in the next section.

# filter cells looking like blanks

To filter cells looking like blanks, we use the SVM-bagging algorithm
implemented in the function `QC_*`. The goal is the run multiple SVM
classification between a group of cells identified as blanks in the data and
a group of random cells that should not contain to much cells looking like
blanks.

We use the software `paraload` to manage the computation in parallel.

The required files are generated by the following commands:

```R
system("mkdir -p results/QC/QC_paraload/abundance/")
system("mkdir -p results/QC/QC_paraload/counts/")
scRNAtools::QC_paraload_parameters(
  paraload_file = "results/QC/paraload.csv",
  bootstraps = 100000,
  job_boot_number = 50
)
```

Then we launch the `paraload` server:

```sh
bin/paraload --server \
--port 13469 \
--input results/QC/paraload.csv \
--output results/QC/paraload_counts_run.txt \
--log results/QC/paraload_counts.log \
--report results/QC/paraload_counts_report.txt \
--conf src/pbs/QC/QC_counts.conf
```

And we can spawn the computation over the network by launching `paraload`
clients (with pbil-deb being the name of computer on which the server is
running).

```sh
bin/paraload --client --port 13469 --host pbil-deb
```

Once the analysis done, the `paraload` server will shutdown and we can run the
following command to load the results:

```R
load("results/counts.Rdata")
devtools::load_all("../scRNAtools/", reset = T)
scRNAtools::QC_load_bootstraps(
  scd = scd,
  paraload_folder = "results/QC/QC_paraload/counts",
)
```

This will add a `QC_score` feature to the `scd` object that summarize the
proportion of time that a give cells was classified as looking like a non blank
cells (the true blanks have a score of zero).
Following on the hypothesis that our sequencing should be good for most cells
we perform a last SVM classification of the cells learning from the group of
blanks and the group of the 50\% top `QC_score` cells.

```R
scRNAtools::QC_classification(
  scd = scd,
  quant = 0.5
)
save(scd, file = "results/QC/counts_QC.Rdata")
```

This procedure identify 54 cells as looking more like blank than other cells.

The following two PCA's show those cells and the data without them.

\begin{center}
  \begin{figure}
    \includegraphics[width=0.5\textwidth]{../results/QC/pca/pca_counts_QC.pdf}\includegraphics[width=0.5\textwidth]{../results/QC/pca/pca_counts_QC_good.pdf}
    \caption{PCA plot for cells classified as looking like blank (in color or transparency)}
  \end{figure}
\end{center}

# normalize for batch effect

When we look a the different time-points, we can see some batch effect,
especially for the day 136.

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_counts_QC_good_D593.pdf}
    \caption{PCA plot for cells not looking like blanks}
  \end{figure}
\end{center}

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_counts_QC_good_D593.pdf}
    \caption{pCMF plot for cells not looking like blanks}
  \end{figure}
\end{center}

We use the following command to normalize batch effect within each day's data:

```R
load("results/QC/counts_QC.Rdata")
for (day in c("D15", "D136", "D593")) {
    scd <- normalize(
    scd = scd,
    b_cells = scd$getfeature("QC_good") %in% T & scd$getfeature("day") %in% day,
    method = "ComBat",
    cpus = 5,
    tmp_file = paste0("results/tmp/normalization_combat_,", day, "_tmp.Rdata")
  )
}
save(scd, file = "results/QC/batch_counts_QC.Rdata")
```

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_batch_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_batch_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_batch_counts_QC_good_D593.pdf}
    \caption{pca plot for batch effect normalization}
  \end{figure}
\end{center}

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_batch_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_batch_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_batch_counts_QC_good_D593.pdf}
    \caption{pCMF plot for batch effect normalization}
  \end{figure}
\end{center}

# normalize of cells effect

We also generate a `scdata` object normalized for cells effect, with the
following command:

```R
load("results/QC/counts_QC.Rdata")
scd <- normalize(
  scd = scd,
  b_cells = scd$getfeature("QC_good") %in% T,
  method = "SCnorm",
  cpus = 4,
  tmp_file = "results/tmp/normalization_tmp.Rdata"
)
save(scd, file = "results/QC/cells_counts_QC.Rdata")
```

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_cells_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_cells_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_cells_counts_QC_good_D593.pdf}
    \caption{pca plot for cells effect normalization}
  \end{figure}
\end{center}

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_cells_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_cells_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_cells_counts_QC_good_D593.pdf}
    \caption{pCMF plot for cells effect normalization}
  \end{figure}
\end{center}

# normalize of cells and batch effect

We also generate a `scdata` object normalized for cells effect, with the
following command:

```R
load("results/QC/cells_counts_QC.Rdata")
for (day in c("D15", "D136", "D593")) {
    scd <- normalize(
    scd = scd,
    b_cells = scd$getfeature("QC_good") %in% T & scd$getfeature("day") %in% day,
    method = "ComBat",
    cpus = 5,
    tmp_file = paste0("results/tmp/normalization_cells_combat_,", day, "_tmp.Rdata")
  )
}
save(scd, file = "results/QC/CB_counts_QC.Rdata")
```

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_CB_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_CB_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pca/pca_CB_counts_QC_good_D593.pdf}
    \caption{PCA plot for cells and batch effect normalization}
  \end{figure}
\end{center}

\begin{center}
  \begin{figure}
    \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_CB_counts_QC_good_D15.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_CB_counts_QC_good_D136.pdf} \includegraphics[width=0.3\textwidth]{../results/QC/pcmf/pcmf_CB_counts_QC_good_D593.pdf}
    \caption{pCMF plot for cells and batch effect normalization}
  \end{figure}
\end{center}

# analysis of the Female donor data

For the female donor, we knew before hand that the data were of lesser quality
and with fewer cells. To be more precise and to obtain a comparable QC methods
with the Male donor we used the results of the Male QC analysis as a learning
set to classify the Female cells.

We start by attributing the `QC_score` of 0.5 to all Female cells, which should
place them between the blank looking and non blank looking Male cells.

```R
scd$setfeature("QC_score",
  ifelse(scd$getfeature("sex") %in% "F",
    0.5,
    scd$getfeature("QC_score")
  )
)
scd$setfeature("to_QC",
  ifelse(scd$getfeature("sex") %in% "F",
    TRUE,
    scd$getfeature("to_QC")
  )
)
```

Then we use an SVM classification learning from the set of `QC_good == T` and
the set of `QC_good == F` in the Male donor.

```R
scRNAtools::QC_classification(
  scd = scd,
  is_blank = scd$getfeature("QC_score") <= 0.5
)
save(scd, file = "results/QC/counts_QC_F.Rdata")
```

We identify 314 cells looking like blanks and 262 cells looking like non blanks.
